<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ã‹ã‚‰ã ãƒã‚§ãƒƒã‚¯è¨˜éŒ² Ã— ã‚°ãƒ©ãƒ•åˆ†æ</title>

  <!-- Chart.jsï¼ˆJSå´ã§ä½¿ç”¨ï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* ========= åŸºæœ¬ ========= */
    :root {
      --bg:#f5f7fb;
      --card:#ffffff;
      --border:#e2e6f0;
      --primary:#2563eb;
      --text:#1f2937;
      --muted:#6b7280;
    }

    * { box-sizing:border-box; }

    body {
      margin:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,sans-serif;
      background:var(--bg);
      color:var(--text);
    }

    /* ========= ãƒ˜ãƒƒãƒ€ãƒ¼ ========= */
    header {
      position:sticky;
      top:0;
      z-index:10;
      background:var(--card);
      border-bottom:1px solid var(--border);
      padding:14px 20px;
    }
    header h1 {
      margin:0;
      font-size:18px;
    }
    header p {
      margin:4px 0 0;
      font-size:12px;
      color:var(--muted);
    }

    /* ========= ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ ========= */
    .container {
      max-width:1200px;
      margin:0 auto;
      padding:16px;
      display:grid;
      grid-template-columns:2fr 1fr;
      gap:16px;
    }
    @media (max-width:900px){
      .container { grid-template-columns:1fr; }
    }

    section {
      background:var(--card);
      border-radius:10px;
      border:1px solid var(--border);
      padding:14px;
    }
    section + section { margin-top:14px; }

    h2 {
      font-size: 15px;
      margin: 0 0 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    h2 .inline-btn {
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: #fff;
      cursor: pointer;
      transition: background 0.2s;
    }

    h2 .inline-btn:hover {
      background: #f3f4f6;
    }

    h2 span {
      font-size:11px;
      color:var(--muted);
      font-weight:normal;
    }

    header {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    header h1,
    header p {
      margin: 0;
    }

    header .header-text {
      display: flex;
      flex-direction: column;
    }

    #langToggle {
      margin-left: auto; /* â† å³å¯„ã›ã®æœ¬ä½“ */
    }

    /* =========================
      ãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†UI
    ========================= */
    .sidebar-section {
      position: relative;
      overflow: visible;
      z-index: 1;
      font-size: 90%;
    }

    /* ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œè¡Œï¼ˆã‚»ãƒ¬ã‚¯ãƒˆï¼‹æ–°è¦ï¼‹å‰Šé™¤ï¼‰ */
    .file-controls {
      display: flex;
      gap: 4px;
      align-items: center;
      margin-bottom: 6px;
    }

    /* ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ */
    #fileSelect {
      flex: 1;
      min-width: 0;
      max-width: 100%;
      position: relative;
      z-index: 10;
      padding: 4px;
      font-size: 90%;
    }

    /* æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«åå…¥åŠ› */
    #newFileName {
      width: 6em;
      padding: 4px;
      font-size: 90%;
    }

    /* ãƒœã‚¿ãƒ³å…±é€š */
    .sidebar-section button.ghost {
      padding: 4px 6px;
      font-size: 90%;
      cursor: pointer;
      background: none;
      border: 1px solid #ccc;
      border-radius: 4px;
      transition: background 0.2s;
    }

    .sidebar-section button.ghost:hover {
      background: #f0f0f0;
    }

    /* å‰Šé™¤ãƒœã‚¿ãƒ³ï¼ˆèµ¤ï¼‰ */
    #deleteFile {
      color: #b91c1c;
      border-color: #e5e5e5;
    }

    /* ç¾åœ¨ã®ãƒ•ã‚¡ã‚¤ãƒ«åè¡¨ç¤ºï¼ˆæ§ãˆã‚ï¼‰ */
    #currentFileLabel {
      margin-top: 6px;
      font-size: 90%;
      color: #555;
    }

    /* ========= ãƒ•ã‚©ãƒ¼ãƒ  ========= */
    form {
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:10px;
    }
    .full { grid-column:1/-1; }

    label {
      font-size:12px;
      display:flex;
      flex-direction:column;
      gap:4px;
    }

    input, select, textarea {
      padding:7px 8px;
      font-size:13px;
      border-radius:6px;
      border:1px solid var(--border);
    }
    textarea {
      min-height:50px;
      resize:vertical;
    }

    button {
      border:none;
      border-radius:999px;
      padding:8px 14px;
      font-size:13px;
      cursor:pointer;
    }
    .primary {
      background:var(--primary);
      color:#fff;
    }
    .ghost {
      background:transparent;
      border:1px solid var(--border);
    }

    /* ========= ãƒ†ãƒ¼ãƒ–ãƒ« ========= */
    table {
      width:100%;
      border-collapse:collapse;
      font-size:12px;
    }
    thead { background:#f1f3f9; }
    th, td {
      padding:6px;
      border-bottom:1px solid var(--border);
    }

    .empty {
      text-align:center;
      color:var(--muted);
      padding:14px;
    }

    /* å‰Šé™¤åˆ—ã‚’å®Œå…¨ä¸­å¤®å›ºå®š */
    th:last-child,
    td:last-child {
      width: 70px;
      text-align: center;
      padding-left: 0;
      padding-right: 0;
    }

    /* ãƒœã‚¿ãƒ³è‡ªä½“ã‚’ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆåŒ– */
    td:last-child button {
      padding: 4px 10px;
      font-size: 11px;
      line-height: 1;
    }

    /* ãƒ˜ãƒƒãƒ€ä¸­å¤®æƒãˆ */
    thead th {
      text-align: center;
    }

    /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯å·¦ï¼ˆãƒ¡ãƒ¢ãªã©ï¼‰ */
    tbody td {
      text-align: left;
    }

    /* ä¸­å¤®æƒãˆã«ã—ãŸã„åˆ— */
    tbody td:nth-child(1), /* æ™‚é–“ */
    tbody td:nth-child(2), /* éƒ¨ä½ */
    tbody td:nth-child(3), /* ç—‡çŠ¶ */
    tbody td:nth-child(4), /* å¼·ã• */
    tbody td:nth-child(6)  /* å‰Šé™¤ */
    {
      text-align: center;
    }

    .editing-mode {
      background-color: #fff7d6;
      border: 1px solid #facc15;
      border-radius: 6px;
      padding: 8px;
      transition: background-color 0.3s;
    }

header {
  display: flex;
  align-items: center;
  padding: 14px 20px;
}

.header-left {
  flex: 1;                /* å·¦å´ãŒã§ãã‚‹ã ã‘å¹…ã‚’ä½¿ã† */
  display: flex;
  flex-direction: column;
}

.header-buttons {
  display: flex;
  gap: 8px;               /* ãƒœã‚¿ãƒ³åŒå£«ã®é–“éš” */
}

.info-btn,
.feedback-btn {
  padding: 6px 14px;
  border-radius: 999px;
  font-size: 12px;
  border: 1px solid var(--border);
  background: #fff;
  cursor: pointer;
  text-decoration: none;
  color: var(--text);
}

.info-btn:hover,
.feedback-btn:hover {
  background: #f3f4f6;
}


    /* ========= å¼·åº¦ã‚¿ã‚° ========= */
    .tag {
      padding:2px 8px;
      border-radius:999px;
      font-size:11px;
    }
    .weak { background:#e0f2fe; }
    .mid { background:#fef9c3; }
    .strong { background:#fee2e2; }

    /* ========= ãƒ•ã‚£ãƒ«ã‚¿ ========= */
    .filter-group {
      display:flex;
      flex-direction:column;
      gap:8px;
      font-size:12px;
    }

    /* ========= ã‚°ãƒ©ãƒ• ========= */
    .graph-panel {
      height:260px;
    }

    /* =========================
      æ–‡å­—èµ·ã“ã—ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨CSS
      ========================= */
      /* ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³è¦‹å‡ºã—è¡Œã®ãƒœã‚¿ãƒ³ä½ç½®ã‚’æœ€é©åŒ– */
    h2 {
      display: flex;
      align-items: center;
      gap: 6px; 
    }

    h2 span {
      margin-right: auto; 
    }

    h2 .inline-btn {
      border-radius: 80px; 
      font-size: 11px; 
    }

    /* èƒŒæ™¯ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
    #exportModal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.4);
      z-index: 1000;
      display: none;   
      align-items: center;
      justify-content: center;
    }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ«æœ¬ä½“ */
    #exportModal > div {
      background: #ffffff;
      width: 90%;
      max-width: 720px;

      height: 90vh;
      max-height: 90vh;

      padding: 14px;
      border-radius: 10px;

      display: flex;
      flex-direction: column;
      gap: 8px;

      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }

    /* ã‚¿ã‚¤ãƒˆãƒ« */
    #exportModal h3 {
      margin: 0;
      font-size: 14px;
    }

    /* æ–‡å­—èµ·ã“ã—ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ */
    #exportText {
      flex: 1;                  /* æ®‹ã‚Šé«˜ã•ã‚’ã™ã¹ã¦ä½¿ã† */
      width: 100%;
      min-height: 60vh;         /* åˆæœŸè¡¨ç¤ºã§ã‚‚ååˆ†ãªé«˜ã• */

      font-size: 12px;
      line-height: 1.6;
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;

      white-space: pre;         /* æ”¹è¡Œãƒ»æ•´å½¢ã‚’ä¿æŒ */
      overflow-y: auto;         /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã¯ã“ã“ã ã‘ */

      border: 1px solid #e2e6f0;
      border-radius: 6px;
      padding: 8px;

      background: #f9fafb;
    }

    /* ä¸‹éƒ¨ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ */
    #exportModal .modal-actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }

    /* ãƒ¢ãƒã‚¤ãƒ«ï¼ˆã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼è€ƒæ…®ï¼‰ */
    @supports (height: 100dvh) {
      #exportModal > div {
        height: 90dvh;
        max-height: 90dvh;
      }
    }

    #copyExportText {
      transition: all 0.2s ease;
    }

   #copyToast {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);

    font-size: 12px;
    color: #6b7280;

    background: transparent;
    border: none;
    box-shadow: none;
    padding: 0;

    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s ease;

    z-index: 2000;
  }

  </style>
</head>

<body>

<header>
  <div class="header-left">
    <h1>ã‹ã‚‰ã ãƒã‚§ãƒƒã‚¯è¨˜éŒ² Ã— ã‚°ãƒ©ãƒ•åˆ†æ</h1>
    <p>è¨˜éŒ² â†’ çµã‚Šè¾¼ã¿ â†’ å‚¾å‘æŠŠæ¡</p>
  </div>

  <div class="header-buttons">
    <button class="info-btn">ã‚µã‚¤ãƒˆèª¬æ˜</button>
    <a href="https://forms.office.com/Pages/ResponsePage.aspx?id=DQSIkWdsW0yxEjajBLZtrQAAAAAAAAAAAAMAAGI3LWlUQlhQNENWWEFIMElMQjlTOFA3SldWTEUzWi4u" target="_blank" class="feedback-btn">
      ã”æ„è¦‹ãƒ»ã”æ„Ÿæƒ³ã¯ã“ã“ã‹ã‚‰
    </a>
  </div>
</header>


<div class="container">

  <!-- ===== å·¦ã‚«ãƒ©ãƒ  ===== -->
  <div>
    <section class="sidebar-section">
      <div class="file-controls">
      <select id="fileSelect"></select>
      <button id="createFile" class="ghost" title="æ–°è¦ä½œæˆ">ï¼‹</button>
      <button id="deleteFile" class="ghost" title="å‰Šé™¤">ğŸ—‘ï¸</button>
    </div>
    </section>

    <!-- è¨˜éŒ² -->
    <section>
      <h2 id="recordTitle">è¨˜éŒ² <span>ä»Šã®çŠ¶æ…‹</span></h2>

      <form id="entryForm">
        <label>
          æ™‚é–“
          <input type="datetime-local" id="time">
        </label>

        <label>
          éƒ¨ä½
          <input type="text" id="part">
        </label>

        <label>
          ç—‡çŠ¶
          <input type="text" id="symptom">
        </label>

        <label>
          å¼·ã•
          <select id="intensity">
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3" selected>3</option>
            <option value="4">4</option>
            <option value="5">5</option>
          </select>
        </label>

        <label class="full">
          ãƒ¡ãƒ¢
          <textarea id="notes"></textarea>
        </label>

        <button type="submit" class="primary full">
          è¨˜éŒ²ã™ã‚‹
        </button>
      </form>
    </section>

    <!-- ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ -->
    <section>
      <h2 id="timelineTitle">
        ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³
        <button id="exportTextBtn" class="ghost inline-btn">
          ãƒ‡ãƒ¼ã‚¿ã‚’æ–‡å­—ã«å‡ºåŠ›
        </button>
      </h2>

      <table>
        <colgroup>
          <col style="width:140px">
          <col style="width:80px">
          <col style="width:140px">
          <col style="width:70px">
          <col>
          <col style="width:70px">
        </colgroup>
        <thead>
          <tr>
            <th>æ™‚é–“</th>
            <th>éƒ¨ä½</th>
            <th>ç—‡çŠ¶</th>
            <th>å¼·ã•</th>
            <th>ãƒ¡ãƒ¢</th>
            <th></th>
          </tr>
        </thead>

        <tbody id="timeline">
          <!-- JSã§æç”» -->
        </tbody>
      </table>
    </section>

    <button id="undoDelete" class="ghost" style="display:none; margin-top:8px;">
      ç›´å‰ã®å‰Šé™¤ã‚’å…ƒã«æˆ»ã™
    </button>

  </div>

  <!-- ===== å³ã‚«ãƒ©ãƒ  ===== -->
  <div>

    <!-- çµã‚Šè¾¼ã¿ -->
    <section>
      <h2 id="filterTitle">çµã‚Šè¾¼ã¿</h2>

      <div class="filter-group">
        <input type="text" id="fPart" placeholder="éƒ¨ä½">
        <input type="text" id="fSymptom" placeholder="ç—‡çŠ¶">
        
        <label>
          é–‹å§‹æ—¥æ™‚
          <input type="datetime-local" id="fStart">
        </label>

        <label>
          çµ‚äº†æ—¥æ™‚
          <input type="datetime-local" id="fEnd">
        </label>

        <label>å¼·ã•</label>
        <div id="intensityFilter" style="display:flex; gap:6px;">
          <label><input type="checkbox" value="1">1</label>
          <label><input type="checkbox" value="2">2</label>
          <label><input type="checkbox" value="3">3</label>
          <label><input type="checkbox" value="4">4</label>
          <label><input type="checkbox" value="5">5</label>
        </div>

                <label>æ›œæ—¥</label>
        <div id="weekdayFilter" style="display:flex; gap:6px;">
          <label><input type="checkbox" value="1">æœˆ</label>
          <label><input type="checkbox" value="2">ç«</label>
          <label><input type="checkbox" value="3">æ°´</label>
          <label><input type="checkbox" value="4">æœ¨</label>
          <label><input type="checkbox" value="5">é‡‘</label>
          <label><input type="checkbox" value="6">åœŸ</label>
          <label><input type="checkbox" value="0">æ—¥</label>
        </div>

        <div>
          <label>æ™‚é–“å¸¯</label>
          <div id="timeRanges"></div>

          <button type="button" class="ghost" id="addTimeRange">
            ï¼‹
          </button>
        </div>

        <button type="button" class="primary" id="applyFilter">
          çµã‚Šè¾¼ã¿ã‚’é©ç”¨
        </button>

        <button type="button" class="ghost" id="reset">
          ãƒªã‚»ãƒƒãƒˆ
        </button>
      </div>
    </section>

    <!-- ã‚°ãƒ©ãƒ• -->
    <section>
      <h2>ã‚°ãƒ©ãƒ•</h2>

      <div class="filter-group">
        <label>
          Xè»¸
          <select id="xAxis">
            <option value="daily">æ—¥ä»˜</option>
            <option value="period">æ™‚é–“å¸¯</option>
            <option value="part">éƒ¨ä½</option>
            <option value="symptom">ç—‡çŠ¶</option>
          </select>
        </label>

        <label>
          Yè»¸
          <select id="yAxis">
            <option value="count">ä»¶æ•°</option>
            <option value="avg">å¹³å‡å¼·ã•</option>
            <option value="max">æœ€å¤§å¼·ã•</option>
          </select>
        </label>
      </div>

      <div class="graph-panel">
        <canvas id="chart"></canvas>
      </div>
    </section>

  </div>

  <div id="exportModal" style="
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.4);
  z-index:1000;
  align-items:center;
  justify-content:center;
">
  <div style="
    background:#fff;
    width:90%;
    max-width:700px;
    max-height:80vh;
    padding:14px;
    border-radius:10px;
    display:flex;
    flex-direction:column;
    gap:8px;
  ">
    <h3 style="margin:0;">ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³æ–‡å­—èµ·ã“ã—</h3>

    <textarea
      id="exportText"
      readonly
      style="
        flex:1;
        width:100%;
        font-size:12px;
        line-height:1.6;
        white-space:pre;
      ">
    </textarea>

    <div style="display:flex; gap:6px; justify-content:flex-end;">
      <button id="copyExportText" class="ghost">ã‚³ãƒ”ãƒ¼</button>
      <button id="closeExportModal" class="primary">é–‰ã˜ã‚‹</button>
    </div>

  </div>
</div>
</div>
<div id="copyToast">ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ</div>
</body>

<script>
const exportText = document.getElementById("exportText");
const exportModal = document.getElementById("exportModal");
const entryForm = document.getElementById("entryForm");
const time = document.getElementById("time");
const part = document.getElementById("part");
const symptom = document.getElementById("symptom");
const intensity = document.getElementById("intensity");
const notes = document.getElementById("notes");

const infoBtn = document.querySelector(".info-btn");

// ãƒ¢ãƒ¼ãƒ€ãƒ«ä½œæˆ
const infoModal = document.createElement("div");
infoModal.style.cssText = `
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.4);
  z-index:1200;
  align-items:center;
  justify-content:center;
`;

infoModal.innerHTML = `
  <div style="
    background:#fff;
    padding:16px;
    border-radius:10px;
    max-width:500px;
    width:90%;
    max-height:80vh;
    overflow-y:auto;
    display:flex;
    flex-direction:column;
    gap:8px;
  ">
    <h3>ã‚µã‚¤ãƒˆèª¬æ˜</h3>
    <p>
    ã“ã®ã‚µã‚¤ãƒˆã§ã¯ã€ã”è‡ªèº«ã®ä½“ã®çŠ¶æ…‹ã‚’ç°¡å˜ã«è¨˜éŒ²ã§ãã¾ã™ã€‚<br>
    å…¥åŠ›ã—ãŸãƒ‡ãƒ¼ã‚¿ã¯è‡ªå‹•ã§ã¾ã¨ã‚ã‚‰ã‚Œã€ã‚°ãƒ©ãƒ•åŒ–ã‚‚å¯èƒ½ã§ã™ã®ã§ã€æ—¥ã€…ã®å‚¾å‘ã‚’æŠŠæ¡ã™ã‚‹ã®ã«å½¹ç«‹ã¡ã¾ã™ã€‚<br>
    åŒ»å¸«ã«è¦‹ã›ã‚‹è³‡æ–™ã¨ã—ã¦ã‚‚ä¾¿åˆ©ã§ã™ã€‚<br>
    ã¾ãŸã€è¨˜éŒ²ã‚’æ–‡æ›¸ã¨ã—ã¦å‡ºåŠ›ã™ã‚‹ã“ã¨ã‚‚ã§ãã€å€‹äººã§ã”åˆ©ç”¨ã®AIã‚¢ãƒ—ãƒªç­‰ã‚’ä½¿ã£ã¦ä½“èª¿ã®å¤‰åŒ–ã‚’æ•´ç†ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚<br><br>
    ã”å®‰å¿ƒãã ã•ã„ã€‚å€‹äººæƒ…å ±ã¯ä¸€åˆ‡å–å¾—ã—ã¦ãŠã‚‰ãšã€å®‰å…¨ã«ã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã™ã€‚<br><br>
    çš†ã•ã¾ã®ä½“èª¿ç®¡ç†ãŒå°‘ã—ã§ã‚‚æ¥½ã«ãªã‚‹ã“ã¨ã‚’é¡˜ã£ã¦ã„ã¾ã™ã€‚
    </p>
    <button id="closeInfoModal" class="ghost">é–‰ã˜ã‚‹</button>
  </div>
`;
document.body.appendChild(infoModal);

// ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§è¡¨ç¤º
infoBtn.addEventListener("click", () => {
  infoModal.style.display = "flex";
});

// é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³
document.getElementById("closeInfoModal").addEventListener("click", () => {
  infoModal.style.display = "none";
});

/* =========================
   å®šæ•°ãƒ»çŠ¶æ…‹
========================= */
let entries = [];
let filtered = [];
let chartInstance = null;

/* =========================
   file
========================= */
let currentFile = null;
const FILE_PREFIX = "body_check_";

// ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’å–å¾—
function getFileList() {
  return Object.keys(localStorage)
    .filter(k => k.startsWith(FILE_PREFIX))
    .map(k => k.replace(FILE_PREFIX, ""));
}

// ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€
function loadFile(name) {
  currentFile = name;

  const raw = localStorage.getItem(FILE_PREFIX + name);
  entries = raw ? JSON.parse(raw).map(e => ({ ...e, time: new Date(e.time) })) : [];

  deletedStack = JSON.parse(sessionStorage.getItem("deletedStack_" + name) || "[]");

  document.getElementById("undoDelete").style.display = deletedStack.length ? "" : "none";

  applyFilter();
  renderAll();
  updateFileSelect();
}

// ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’ã‚»ãƒ¬ã‚¯ãƒˆã«åæ˜ 
function updateFileSelect() {
  const select = document.getElementById("fileSelect");
  const files = getFileList();

  select.innerHTML = "";
  files.forEach(name => {
    const opt = document.createElement("option");
    opt.value = name;
    opt.textContent = name;
    if (name === currentFile) opt.selected = true;
    select.appendChild(opt);
  });
}

// ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
document.getElementById("createFile").addEventListener("click", () => {
  const name = prompt("æ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
  if (!name) return;
  if (getFileList().includes(name)) return alert("ãã®ãƒ•ã‚¡ã‚¤ãƒ«åã¯ã™ã§ã«å­˜åœ¨ã—ã¾ã™");

  localStorage.setItem(FILE_PREFIX + name, "[]");
  sessionStorage.setItem("deletedStack_" + name, "[]");
  loadFile(name);
});


// ãƒ•ã‚¡ã‚¤ãƒ«åˆ‡ã‚Šæ›¿ãˆ
document.getElementById("fileSelect").addEventListener("change", e => {
  loadFile(e.target.value);
});

/* =========================
   å‰Šé™¤å±¥æ­´ã‚¹ã‚¿ãƒƒã‚¯ï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸­ä¿æŒï¼‰
========================= */
let deletedStack = [];

/* =========================
   è¨˜éŒ²ä¿å­˜
========================= */
entryForm.addEventListener("submit", e => {
  e.preventDefault();

  const editingId = entryForm.dataset.editingId; // ç·¨é›†IDå–å¾—
  const isEditing = !!editingId;                // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰åˆ¤å®š

  const newEntry = {
    id: isEditing ? Number(editingId) : Date.now(),
    time: new Date(time.value),
    part: part.value.trim(),
    symptom: symptom.value.trim(),
    intensity: Number(intensity.value),
    notes: notes.value.trim()
  };

  if (isEditing) {
    const index = entries.findIndex(e => e.id === Number(editingId));
    if (index !== -1) {
      entries[index] = newEntry;
    }
  } else {
    entries.push(newEntry);
  }

  localStorage.setItem(FILE_PREFIX + currentFile, JSON.stringify(entries));

  entryForm.reset();
  intensity.value = 3;
  time.value = new Date(Date.now() + 9 * 3600000).toISOString().slice(0,16);

  delete entryForm.dataset.editingId;
  entryForm.querySelector("button").textContent = "è¨˜éŒ²ã™ã‚‹";
  entryForm.classList.remove("editing-mode"); 

  applyFilter();
  renderAll();
});

/* =========================
   ãƒ•ã‚£ãƒ«ã‚¿å‡¦ç†ï¼ˆå®Œå…¨ç‰ˆï¼‰
========================= */
function applyFilter() {
  // æ›œæ—¥ï¼ˆãƒã‚§ãƒƒã‚¯ã•ã‚ŒãŸã‚‚ã®ã ã‘æœ‰åŠ¹ï¼‰
  const checkedDays = [...document.querySelectorAll(
    "#weekdayFilter input:checked"
  )].map(cb => Number(cb.value));

  // å¼·ã•ï¼ˆ1ã€œ5 ãƒã‚§ãƒƒã‚¯å¼ï¼‰
  const checkedIntensity = [...document.querySelectorAll(
    "#intensityFilter input:checked"
  )].map(cb => Number(cb.value));

  // æ™‚é–“å¸¯ï¼ˆè¤‡æ•°ãƒ¬ãƒ³ã‚¸ ORï¼‰
  const timeRanges = [...document.querySelectorAll("#timeRanges > div")]
    .map(div => ({
      start: Number(div.querySelector(".start").value),
      end: Number(div.querySelector(".end").value)
    }));

  filtered = entries.filter(e => {
    // éƒ¨ä½
    if (fPart.value && !e.part.includes(fPart.value)) return false;

    // ç—‡çŠ¶
    if (fSymptom.value && !e.symptom.includes(fSymptom.value)) return false;

    // å¼·ã•ï¼ˆORï¼‰
    if (checkedIntensity.length &&
        !checkedIntensity.includes(e.intensity)) {
      return false;
    }

    // é–‹å§‹æ—¥æ™‚
    if (fStart.value && e.time < new Date(fStart.value)) return false;

    // çµ‚äº†æ—¥æ™‚
    if (fEnd.value && e.time > new Date(fEnd.value)) return false;

    // æ›œæ—¥ï¼ˆORï¼‰
    if (checkedDays.length &&
        !checkedDays.includes(e.time.getDay())) {
      return false;
    }

    // æ™‚é–“å¸¯ï¼ˆORï¼‰
    const isCustomTimeRange =
      timeRanges.some(r => r.start !== 0 || r.end !== 24);

    if (isCustomTimeRange) {
      const hour = e.time.getHours();
      const hit = timeRanges.some(r =>
        hour >= r.start && hour < r.end
      );
      if (!hit) return false;
    }

    return true;
  });
}
const fStart = document.getElementById("fStart");
const fEnd = document.getElementById("fEnd");

// â˜…ã“ã“ã«ç½®ãâ˜…
fStart.addEventListener("focus", () => {
  if (!fStart.value) {
    const today = new Date().toISOString().split("T")[0];
    fStart.value = `${today}T00:00`;
  }
});

fEnd.addEventListener("focus", () => {
  if (!fEnd.value) {
    const today = new Date().toISOString().split("T")[0];
    fEnd.value = `${today}T23:59`;
  }
});

/* =========================
   æ›œæ—¥ãƒ»æ™‚é–“å¸¯ãƒ•ã‚£ãƒ«ã‚¿ç”¨
========================= */

// æ™‚é–“å¸¯ãƒ¬ãƒ³ã‚¸ç”Ÿæˆ
function createTimeRange(start = 0, end = 24) {
  const div = document.createElement("div");
  div.style.display = "flex";
  div.style.gap = "6px";
  div.style.alignItems = "center";

  div.innerHTML = `
    <input type="range" min="0" max="23" value="${start}" class="start">
    <input type="range" min="1" max="24" value="${end}" class="end">
    <span class="label"></span>
    <button type="button" class="ghost remove">Ã—</button>
  `;

  const startInput = div.querySelector(".start");
  const endInput   = div.querySelector(".end");
  const label      = div.querySelector(".label");

  const update = () => {
    let s = Number(startInput.value);
    let e = Number(endInput.value);
    if (s >= e) e = s + 1;
    endInput.value = e;
    label.textContent = `${s}:00 - ${e}:00`;
  };

  startInput.addEventListener("input", update);
  endInput.addEventListener("input", update);

  div.querySelector(".remove").onclick = () => div.remove();

  update();
  return div;
}

// ãƒ¬ãƒ³ã‚¸è¿½åŠ 
document.getElementById("addTimeRange")
  .addEventListener("click", () => {
    document.getElementById("timeRanges")
      .appendChild(createTimeRange());
  });

/* =========================
   å…¨ä½“å†æç”»
========================= */
function renderAll() {
  renderTimeline();
  renderGraph();
}

/* =========================
   ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³
========================= */
function renderTimeline() {
  timeline.innerHTML = "";

  if (!filtered.length) {
    timeline.innerHTML =
      `<tr><td colspan="6" class="empty">è©²å½“ãªã—</td></tr>`;
    return;
  }

  filtered.slice(-20).reverse().forEach(e => {
    const cls =
      e.intensity <= 2 ? "weak" :
      e.intensity >= 4 ? "strong" : "mid";

    timeline.insertAdjacentHTML("beforeend", `
      <tr>
        <td>${e.time.toLocaleString()}</td>
        <td>${e.part || "â€”"}</td>
        <td>${e.symptom || "â€”"}</td>
        <td><span class="tag ${cls}">${e.intensity}</span></td>
        <td>${e.notes || ""}</td>
        <td>
          <button class="ghost edit-btn" data-id="${e.id}">ç·¨é›†</button>
          <button class="ghost delete-btn" data-delete-id="${e.id}">å‰Šé™¤</button>
        </td>
      </tr>
    `);
  });

  // å‰Šé™¤ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²
  timeline.querySelectorAll(".delete-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      deleteEntry(Number(btn.dataset.deleteId));
    });
  });

  // ç·¨é›†ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²
  timeline.querySelectorAll(".edit-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      const id = Number(btn.dataset.id);
      const entry = entries.find(e => e.id === id);
      if (!entry) return;

      time.value = new Date(entry.time).toISOString().slice(0,16);
      part.value = entry.part;
      symptom.value = entry.symptom;
      intensity.value = entry.intensity;
      notes.value = entry.notes;

      entryForm.dataset.editingId = id;
      entryForm.querySelector("button").textContent = "æ›´æ–°";
      entryForm.classList.add("editing-mode");
    });
  });
}

/* =========================
   å‰Šé™¤å‡¦ç†ï¼ˆå±¥æ­´ã«è¿½åŠ ã—ã¦å‰Šé™¤ï¼‰
========================= */
function deleteEntry(id) {
  const index = entries.findIndex(e => e.id === id);
  if (index === -1) return;

  const deleted = entries[index];
  deletedStack.push(deleted);
  sessionStorage.setItem("deletedStack_" + currentFile, JSON.stringify(deletedStack));

  entries.splice(index, 1);
  localStorage.setItem(FILE_PREFIX + currentFile, JSON.stringify(entries));

  document.getElementById("undoDelete").style.display = "";
  applyFilter();
  renderTimeline(); // â† ã“ã‚Œã ã‘ã§OK
}

/* =========================
   æˆ»ã™å‡¦ç†ï¼ˆå±¥æ­´ã‹ã‚‰å¾©å…ƒï¼‰
========================= */
document.getElementById("undoDelete").addEventListener("click", () => {
  if (!deletedStack.length) return;

  const restored = deletedStack.pop();
  sessionStorage.setItem("deletedStack_" + currentFile, JSON.stringify(deletedStack));

  entries.push({ ...restored, time: new Date(restored.time) });
  entries.sort((a, b) => a.time - b.time);
  localStorage.setItem(FILE_PREFIX + currentFile, JSON.stringify(entries));

  if (!deletedStack.length) {
    document.getElementById("undoDelete").style.display = "none";
  }

  applyFilter();
  renderAll();
});

document.addEventListener("DOMContentLoaded", () => {
  // ======================
  // ãƒ•ã‚¡ã‚¤ãƒ«åˆæœŸãƒ­ãƒ¼ãƒ‰
  // ======================
  const files = getFileList();
  if (files.length) {
    loadFile(files[0]);
  } else {
    localStorage.setItem(FILE_PREFIX + "default", "[]");
    sessionStorage.setItem("deletedStack_default", "[]");
    loadFile("default");
  }

  // ======================
  // å…¥åŠ›åˆæœŸæ™‚åˆ»ï¼ˆJSTï¼‰
  // ======================
  document.getElementById("time").value =
    new Date(Date.now() + 9 * 3600000).toISOString().slice(0, 16);

  // ======================
  // æ™‚é–“å¸¯ãƒ•ã‚£ãƒ«ã‚¿ï¼šåˆæœŸ1ä»¶ä¿è¨¼
  // ======================
  const tr = document.getElementById("timeRanges");
  if (tr && !tr.children.length) {
    tr.appendChild(createTimeRange());
  }
});

/* =========================
   ã‚°ãƒ©ãƒ•æç”»
========================= */
function renderGraph() {
  const canvas = document.getElementById("chart");
  const ctx = canvas.getContext("2d");

  if (!filtered.length) {
    if (chartInstance) {
      chartInstance.destroy();
      chartInstance = null;
    }
    return;
  }

  const xType = xAxis.value;
  const yType = yAxis.value;

  const summary = {};

  filtered.forEach(e => {
    let key = "æœªæŒ‡å®š";

    switch (xType) {
      case "daily":
        key = e.time.toISOString().slice(0, 10);
        break;
      case "period":
        const h = e.time.getHours();
        key = h < 6 ? "å¤œ" : h < 12 ? "æœ" : h < 18 ? "æ˜¼" : "å¤•";
        break;
      case "part":
        key = e.part || "æœªæŒ‡å®š";
        break;
      case "symptom":
        key = e.symptom || "æœªæŒ‡å®š";
        break;
    }

    if (!summary[key]) {
      summary[key] = { count: 0, sum: 0, max: 0 };
    }

    summary[key].count++;
    summary[key].sum += e.intensity;
    summary[key].max = Math.max(summary[key].max, e.intensity);
  });

  let labels = Object.keys(summary);
  if (xType === "daily") labels.sort();

  let data = [];
  let labelText = "";

  switch (yType) {
    case "avg":
      data = labels.map(k => +(summary[k].sum / summary[k].count).toFixed(2));
      labelText = "å¹³å‡å¼·ã•";
      break;
    case "max":
      data = labels.map(k => summary[k].max);
      labelText = "æœ€å¤§å¼·ã•";
      break;
    default:
      data = labels.map(k => summary[k].count);
      labelText = "ä»¶æ•°";
  }

  if (chartInstance) chartInstance.destroy();

  chartInstance = new Chart(ctx, {
    type: xType === "daily" ? "line" : "bar",
    data: {
      labels,
      datasets: [{
        label: labelText,
        data: data,
        borderWidth: 2,
        borderColor: getComputedStyle(document.documentElement)
          .getPropertyValue("--primary")
          .trim(),
        backgroundColor: xType === "daily"
          ? getComputedStyle(document.documentElement)
              .getPropertyValue("--primary")
              .trim() + "40"   // é€æ˜åº¦25%
          : getComputedStyle(document.documentElement)
              .getPropertyValue("--primary")
              .trim() + "B3",  // é€æ˜åº¦70%
        fill: xType === "daily",
        tension: 0.3
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          max: yType !== "count" ? 5 : undefined
        }
      }
    }
  });
}

/* =========================
   ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²ï¼ˆä¿®æ­£ç‰ˆãƒ»ç¢ºå®šï¼‰
========================= */
// ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤ãƒœã‚¿ãƒ³
document.getElementById("deleteFile").addEventListener("click", () => {
  if (!currentFile) return;

  const confirmDelete = confirm(`ã€Œ${currentFile}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚`);
  if (!confirmDelete) return;

  const deletedName = currentFile; // â† ã“ã“ã§é€€é¿ï¼

  // localStorage ã¨ sessionStorage ã‹ã‚‰å‰Šé™¤
  localStorage.removeItem(FILE_PREFIX + deletedName);
  sessionStorage.removeItem("deletedStack_" + deletedName);

  // ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’æ›´æ–°
  const files = getFileList().filter(name => name !== deletedName);

  if (files.length) {
    loadFile(files[0]); // æ®‹ã£ã¦ã„ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€
  } else {
    const fallback = "default";
    localStorage.setItem(FILE_PREFIX + fallback, "[]");
    sessionStorage.setItem("deletedStack_" + fallback, "[]");
    loadFile(fallback);
  }

  alert(`ã€Œ${deletedName}ã€ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚`);
});

// çµã‚Šè¾¼ã¿é©ç”¨
document.getElementById("applyFilter").addEventListener("click", () => {
  applyFilter();
  renderAll();
});

// ãƒªã‚»ãƒƒãƒˆ
document.getElementById("reset").addEventListener("click", () => {
  fPart.value = "";
  fSymptom.value = "";
  fStart.value = "";
  fEnd.value = "";

  document
    .querySelectorAll("#weekdayFilter input")
    .forEach(cb => cb.checked = false);

  document
    .querySelectorAll("#intensityFilter input")
    .forEach(cb => cb.checked = false);

  const container = document.getElementById("timeRanges");
  container.innerHTML = "";
  container.appendChild(createTimeRange());

  applyFilter();
  renderAll();
});

// â˜… Xè»¸å¤‰æ›´ â†’ å³ã‚°ãƒ©ãƒ•å†æç”»
document.getElementById("xAxis").addEventListener("change", () => {
  renderGraph();
});

// â˜… Yè»¸å¤‰æ›´ â†’ å³ã‚°ãƒ©ãƒ•å†æç”»
document.getElementById("yAxis").addEventListener("change", () => {
  renderGraph();
});

function openExportModal() {
  const modal = document.getElementById("exportModal");
  const textarea = document.getElementById("exportText");

  const text = filtered
    .map(e => {
      const date = e.time.toLocaleString();
      return `${date} / ${e.part} / ${e.symptom} / å¼·ã•:${e.intensity}\n${e.notes || ""}`;
    })
    .join("\n\n");

  textarea.value = text;
  modal.style.display = "flex";
}

document.getElementById("exportTextBtn")
  .addEventListener("click", openExportModal);

document.getElementById("closeExportModal")
  .addEventListener("click", () => {
    exportModal.style.display = "none";
  });

const copyBtn = document.getElementById("copyExportText");
const toast = document.getElementById("copyToast");

copyBtn.addEventListener("click", () => {
  exportText.select();
  document.execCommand("copy");

  copyBtn.textContent = "ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ";
  copyBtn.style.opacity = "0.65";

  toast.style.opacity = "1";

  setTimeout(() => {
    copyBtn.textContent = "ã‚³ãƒ”ãƒ¼";
    copyBtn.style.opacity = "";
    toast.style.opacity = "0";
  }, 1200);
});

</script>

</body>
</html>
